Sub CreateFoldersAndCopyFiles()
    Dim ws As Worksheet
    Dim sourceWorkbook As Workbook
    Dim sourceSheet As Worksheet
    Dim rulesWorkbook As Workbook
    Dim rulesSheet As Worksheet
    Dim newWorkbook As Workbook
    Dim coordinatorsFolderPath As String
    Dim sharedDrivePath As String
    Dim U99FilePath As String
    Dim folderName As String
    Dim fileName As String
    Dim sheetName As String
    Dim filePath As String
    Dim i As Long
    Dim dict As Object
    Dim key As String
    Dim filterCriteria As Variant
    
    ' Define the shared drive path
    sharedDrivePath = "//shared drive/"
    
    ' Define the source file path
    U99FilePath = sharedDrivePath & "U99.xlsx"
    
    ' Open the rules workbook
    Set rulesWorkbook = Workbooks.Open(sharedDrivePath & "rules.xlsx")
    Set rulesSheet = rulesWorkbook.Sheets(1)
    
    ' Define the Coordinators folder path
    coordinatorsFolderPath = sharedDrivePath & "Coordinators"
    
    ' Check if the Coordinators folder exists, if not, create it
    If Dir(coordinatorsFolderPath, vbDirectory) = "" Then
        MkDir coordinatorsFolderPath
    End If
    
    ' Create a dictionary to store filters for each unique file
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Loop through the rows in rules sheet starting from row 3
    i = 3
    Do While rulesSheet.Cells(i, 15).Value <> "" ' Column O
        fileName = rulesSheet.Cells(i, 15).Value ' File name from column O
        folderName = rulesSheet.Cells(i, 12).Value ' Folder name from column L
        sheetName = rulesSheet.Cells(i, 14).Value ' Sheet name from column N
        
        ' Get filter criteria from columns E, F, G
        filterCriteria = Array(rulesSheet.Cells(i, 5).Value, rulesSheet.Cells(i, 6).Value, rulesSheet.Cells(i, 7).Value) ' Columns E, F, G
        
        ' Store the filter criteria in the dictionary
        key = fileName & "|" & folderName & "|" & sheetName
        If Not dict.exists(key) Then
            Set dict(key) = CreateObject("Scripting.Dictionary")
        End If
        dict(key)(i) = filterCriteria
        
        i = i + 1
    Loop
    
    ' Process each unique file
    For Each key In dict.keys
        fileName = Split(key, "|")(0)
        folderName = Split(key, "|")(1)
        sheetName = Split(key, "|")(2)
        
        ' Create the folder inside Coordinators folder, if it does not exist
        If Dir(coordinatorsFolderPath & "\" & folderName, vbDirectory) = "" Then
            MkDir coordinatorsFolderPath & "\" & folderName
        End If
        
        ' Define the file path
        filePath = coordinatorsFolderPath & "\" & folderName & "\" & fileName & ".xlsx"
        
        ' Delete the file if it already exists
        If Dir(filePath) <> "" Then
            Kill filePath
        End If
        
        ' Open the source workbook
        Set sourceWorkbook = Workbooks.Open(U99FilePath)
        Set sourceSheet = sourceWorkbook.Sheets("Output")
        
        ' Copy the "Output" sheet to a new workbook
        sourceSheet.Copy
        Set newWorkbook = ActiveWorkbook
        newWorkbook.Sheets(1).Name = sheetName
        
        ' Apply filters based on the combined criteria
        For Each idx In dict(key).keys
            filterCriteria = dict(key)(idx)
            
            ' Filter column CR (column 3), CT (column 20), CV (column 22)
            If filterCriteria(2) <> "ALL" Then
                newWorkbook.Sheets(1).Range("A1").AutoFilter Field:=3, Criteria1:=filterCriteria(0) ' Column CR
                newWorkbook.Sheets(1).Range("A1").AutoFilter Field:=20, Criteria1:=filterCriteria(1) ' Column CT
                newWorkbook.Sheets(1).Range("A1").AutoFilter Field:=22, Criteria1:=filterCriteria(2) ' Column CV
            End If
        Next idx
        
        ' Save the new workbook with the new file name inside the relevant folder
        newWorkbook.SaveAs Filename:=filePath, FileFormat:=xlOpenXMLWorkbook
        newWorkbook.Close SaveChanges:=False
        
        ' Close the source workbook
        sourceWorkbook.Close SaveChanges:=False
    Next key
    
    ' Close the rules workbook
    rulesWorkbook.Close SaveChanges:=False
    
    MsgBox "Folders and files created successfully!"
End Sub
