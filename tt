import os
import zipfile

# Access the input data from the Email tool
input_data = Alteryx.read("#1")

# Iterate over each email record
for row in input_data:
    subject = row['Subject']
    attachments = row['Attachments']

    # Check if the subject matches 'abcd'
    if subject == 'abcd':
        # Iterate over each attachment
        for attachment in attachments:
            attachment_name = attachment['Name']
            attachment_data = attachment['Data']

            # Save the attachment to a temporary file
            temp_path = os.path.join(os.environ['TEMP'], attachment_name)
            with open(temp_path, 'wb') as file:
                file.write(attachment_data)

            # Check if the attachment is a zip file and unzip it
            if temp_path.endswith('.zip'):
                unzip_location = 'path/to/save/location/'  # Specify the desired location
                os.makedirs(unzip_location, exist_ok=True)  # Create the save location path if it doesn't exist
                with zipfile.ZipFile(temp_path, 'r') as zip_ref:
                    zip_ref.extractall(unzip_location)

            # Move the attachment to the final save location
            save_location = 'path/to/save/location/'  # Specify the desired location
            os.makedirs(save_location, exist_ok=True)  # Create the save location path if it doesn't exist
            final_path = os.path.join(save_location, attachment_name)
            os.rename(temp_path, final_path)

            print(f"Saved attachment: {attachment_name}")

# Output the processed data
Alteryx.write(input_data, "#2")
