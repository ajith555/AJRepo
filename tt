import os
import zipfile
from win32com.client import Dispatch

# Function to extract attachments from email
def extract_attachments(msg, output_dir):
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    attachments = msg.Attachments
    for attachment in attachments:
        attachment_path = os.path.join(output_dir, attachment.FileName)
        attachment.SaveAsFile(attachment_path)

        # Check if it's a zip file and unzip if necessary
        if attachment_path.endswith(".zip"):
            unzip_dir = "path_to_unzip_folder"  # Replace with the desired unzip folder path
            if not os.path.exists(unzip_dir):
                os.makedirs(unzip_dir)

            with zipfile.ZipFile(attachment_path, 'r') as zip_ref:
                zip_ref.extractall(unzip_dir)

# Outlook file details
folder_path = "path_to_folder"  # Replace with the actual folder path containing the .msg files
attachment_dir = "path_to_attachments_folder"  # Replace with the desired attachments folder path

# Iterate through the files in the folder
for file_name in os.listdir(folder_path):
    file_path = os.path.join(folder_path, file_name)

    # Check if the file is an .msg file
    if file_name.endswith(".msg"):
        # Open the .msg file and access the email
        outlook = Dispatch("Outlook.Application")
        namespace = outlook.GetNamespace("MAPI")
        msg = namespace.OpenSharedItem(file_path)

        # Extract attachments
        extract_attachments(msg, attachment_dir)
