import os
import zipfile
from extract_msg import Message

# Set the folder location containing email files
folder_location = 'path/to/emails/'

# Set the save location for attachments
save_location = 'path/to/save/location/'

# Iterate over the files in the folder
for filename in os.listdir(folder_location):
    file_path = os.path.join(folder_location, filename)

    # Check if the file is an .msg file and the subject matches 'abcd'
    if filename.endswith('.msg') and filename.split('.')[0] == 'abcd':
        # Extract attachments from the .msg file
        msg = Message(file_path)
        attachments = msg.attachments

        # Process each attachment
        for attachment in attachments:
            attachment_name = attachment.longFilename
            attachment_data = attachment.data

            # Save the attachment to a file
            attachment_path = os.path.join(save_location, attachment_name)
            with open(attachment_path, 'wb') as file:
                file.write(attachment_data)

            # Check if the attachment is a zip file and unzip it
            if attachment_path.endswith('.zip'):
                unzip_location = os.path.join(save_location, os.path.splitext(attachment_name)[0])
                os.makedirs(unzip_location, exist_ok=True)
                with zipfile.ZipFile(attachment_path, 'r') as zip_ref:
                    zip_ref.extractall(unzip_location)

                print(f"Unzipped attachment: {attachment_name}")
            else:
                print(f"Attachment is not a zip file: {attachment_name}")

            print(f"Saved attachment: {attachment_name}")

        break  # Exit the loop after processing one email
