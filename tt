import os
import zipfile
from msg_extractor import MsgExtractor
from pymsgauth import authenticate_outlook

# Set the folder location containing shared Outlook files
folder_location = 'path/to/shared/folder/'

# Set the save location for attachments
save_location = 'path/to/save/location/'

# Authenticate and access the shared Outlook folder
folder = authenticate_outlook(folder_location)

# Iterate over the Outlook files in the folder
for outlook_file in folder:
    file_path = os.path.join(folder_location, outlook_file)

    # Check if the file is an Outlook file and the subject matches 'abcd'
    if outlook_file.endswith('.msg') and folder[outlook_file].subject == 'abcd':
        # Extract attachments from the Outlook file
        msg = MsgExtractor(file_path)
        attachments = msg.get_attachment_data()

        # Process each attachment
        for attachment in attachments:
            attachment_name = attachment['filename']
            attachment_data = attachment['data']

            # Save the attachment to a file
            attachment_path = os.path.join(save_location, attachment_name)
            with open(attachment_path, 'wb') as file:
                file.write(attachment_data)

            # Check if the attachment is a zip file and unzip it
            if attachment_path.endswith('.zip'):
                unzip_location = os.path.join(save_location, os.path.splitext(attachment_name)[0])
                os.makedirs(unzip_location, exist_ok=True)
                with zipfile.ZipFile(attachment_path, 'r') as zip_ref:
                    zip_ref.extractall(unzip_location)

                print(f"Unzipped attachment: {attachment_name}")
            else:
                print(f"Attachment is not a zip file: {attachment_name}")

            print(f"Saved attachment: {attachment_name}")

        break  # Exit the loop after processing one email
