import win32com.client
import os
import datetime

outlook = win32com.client.Dispatch('outlook.application').GetNamespace("MAPI")
inbox = outlook.GetDefaultFolder('6').Folders('ABCTest')
messages = inbox.Items

messages.Sort("[ReceivedTime]", True)

# Fetch only the latest email with subject containing 'FFTS'
latest_msg = None
for msg in messages:
    if 'FFTS' in str(msg.Subject):
        latest_msg = msg
        break

# Check if there is a latest email with 'FFTS' in the subject
if latest_msg:
    # Fetch To, CC, Subject, and From information from the latest email
    latest_subject = latest_msg.Subject
    latest_to = latest_msg.To
    latest_cc = latest_msg.CC
    latest_sender = latest_msg.SenderName

    print("Latest Subject:", latest_subject)
    print("To:", latest_to)
    print("CC:", latest_cc)
    print("From:", latest_sender)

    path = 'P:/Documents/PycharmProjects/pythonLearning/TestingFolder/'
    if not os.path.exists(path):
        os.makedirs(path)

    for atch in latest_msg.Attachments:
        # Save attachments with unique file names
        attachment_path = os.path.join(path, atch.FileName)
        if os.path.exists(attachment_path):
            # If the file already exists, add date and time as an extension to the file name
            unique_name = os.path.splitext(atch.FileName)
            now = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            new_attachment_name = f"{unique_name[0]}_{now}{unique_name[1]}"
            attachment_path = os.path.join(path, new_attachment_name)

        atch.SaveAsFile(attachment_path)

    print("Attachments saved successfully.")
else:
    print("No emails with subject containing 'FFTS' found in the folder.")
