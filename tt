import os
import zipfile
from msgreader import MSGReader

# Function to extract attachments from email
def extract_attachments(attachment, output_dir):
    file_path = os.path.join(output_dir, attachment.longFilename or attachment.shortFilename)
    with open(file_path, "wb") as f:
        f.write(attachment.data)
    return file_path

# Function to unzip a file
def unzip_file(file_path, output_dir):
    with zipfile.ZipFile(file_path, 'r') as zip_ref:
        zip_ref.extractall(output_dir)

# Email details
email_folder = "path_to_email_folder"  # Replace with the actual folder path
subject = "abc"

# Iterate through the emails in the folder
for email_file in os.listdir(email_folder):
    email_path = os.path.join(email_folder, email_file)

    # Check if the file is an email file
    if email_file.endswith(".msg"):
        # Read the email
        msg = MSGReader(email_path)

        # Check if the email subject matches
        if msg.subject == subject:
            # Download and process attachments
            attachments_dir = "path_to_attachments_folder"  # Replace with the desired attachments folder path
            if not os.path.exists(attachments_dir):
                os.makedirs(attachments_dir)

            for attachment in msg.attachments:
                attachment_path = extract_attachments(attachment, attachments_dir)

                # Check if it's a zip file and unzip if necessary
                if attachment_path and attachment_path.endswith(".zip"):
                    unzip_dir = "path_to_unzip_folder"  # Replace with the desired unzip folder path
                    if not os.path.exists(unzip_dir):
                        os.makedirs(unzip_dir)

                    unzip_file(attachment_path, unzip_dir)
