# Define paths
$sourceFilePath = "C:\Source Files\U99.xlsx"
$rulesFilePath = "C:\rules.xlsx"
$coordinatorsPath = "C:\Coordinators\"

# Check if the Coordinators folder exists, create it if it doesn't
if (-not (Test-Path -Path $coordinatorsPath)) {
    New-Item -ItemType Directory -Path $coordinatorsPath | Out-Null
}

# Load the Excel COM object
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

# Open the rules.xlsx file
$workbook = $excel.Workbooks.Open($rulesFilePath)
$sheet = $workbook.Sheets.Item(1)

# Get the current month and year
$currentMonth = (Get-Date).ToString("MMMM")
$currentYear = (Get-Date).Year

# Get the last row with data in the B column
$lastRow = $sheet.Cells($sheet.Rows.Count, "B").End(-4162).Row

# Delete all contents in the Coordinators folder
Remove-Item -Path "$coordinatorsPath\*" -Recurse -Force

# Create a dictionary to track folders and files
$foldersFiles = @{}

# Loop through the rows starting from the 3rd row
for ($row = 3; $row -le $lastRow; $row++) {
    # Get the folder name from column B and file name from column F
    $folderName = $sheet.Cells.Item($row, 2).Text
    $fileName = $sheet.Cells.Item($row, 6).Text

    # Construct the folder path
    $folderPath = Join-Path $coordinatorsPath $folderName

    # Add file to the list for this folder
    if (-not $foldersFiles.ContainsKey($folderName)) {
        $foldersFiles[$folderName] = @()
    }
    $foldersFiles[$folderName] += $fileName
}

# Process the folders and files
foreach ($folderName in $foldersFiles.Keys) {
    # Construct the folder path
    $folderPath = Join-Path $coordinatorsPath $folderName

    # Check if the folder exists, if not, create it
    if (-not (Test-Path -Path $folderPath)) {
        New-Item -ItemType Directory -Path $folderPath | Out-Null
    }

    # Copy each file to the corresponding folder
    foreach ($fileName in $foldersFiles[$folderName]) {
        # Construct the source file path with the original file name from column F
        $destinationFilePath = Join-Path $folderPath $fileName
        
        # Ensure the file extension is correct
        if (-not $fileName.EndsWith(".xlsx")) {
            $fileName += ".xlsx"
        }

        # Copy the source file to the destination folder, overwriting if it already exists
        Copy-Item -Path $sourceFilePath -Destination $destinationFilePath -Force
    }
}

# Save and close the rules workbook
$workbook.Save()
$workbook.Close()

# Quit Excel application
$excel.Quit()

# Release COM objects to avoid file locking
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheet) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null

# Remove variables
Remove-Variable sheet
Remove-Variable workbook
Remove-Variable excel

Write-Host "Files copied, folders created, and Excel closed successfully."
