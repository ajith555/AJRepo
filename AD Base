Sub Update_AG_Column()
    Dim wbSource As Workbook, wbTarget As Workbook, wbLatAm As Workbook
    Dim wsSource As Worksheet, wsTarget As Worksheet, wsLatAm As Worksheet
    Dim lastRow As Long, lastRowTarget As Long, lastRowLatAm As Long
    Dim filterCol As String, filterValue As String, countryCondition As String, dateRange As String
    Dim AOValue As String, AGValue As String, foundAO As String
    Dim cell As Range
    Dim AGColNum As Long, filterColNum As Long
    
    ' Set workbook references
    Set wbSource = ThisWorkbook  ' Ajith Macro V1.xlsm
    Set wbTarget = Workbooks("UA69_Updated.xlsx")
    Set wbLatAm = Workbooks("WMA BLR_BLC_Rules for Automation.xlsx")
    
    ' Set worksheet references
    Set wsSource = wbSource.Sheets("Job Code Description")
    Set wsTarget = wbTarget.Sheets("Output") ' Use Output sheet in UA69_Updated.xlsx
    Set wsLatAm = wbLatAm.Sheets("LatAm") ' LatAm sheet in WMA BLR_BLC_Rules for Automation
    
    ' Find last row in source, target, and LatAm sheet
    lastRow = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row
    lastRowTarget = wsTarget.Cells(wsTarget.Rows.Count, 1).End(xlUp).Row
    lastRowLatAm = wsLatAm.Cells(wsLatAm.Rows.Count, 2).End(xlUp).Row ' B = AO column in LatAm sheet
    
    ' AG column is the 33rd column in UA69_Updated file
    AGColNum = 33
    
    Dim i As Long, j As Long
    
    ' Loop through each row in Job Code Description sheet
    For i = 2 To lastRow  ' Assuming row 1 is headers
        filterCol = wsSource.Cells(i, 1).Value ' Column name to filter
        filterValue = wsSource.Cells(i, 2).Value ' Value to check in LatAm sheet
        countryCondition = wsSource.Cells(i, 4).Value ' Country condition
        dateRange = wsSource.Cells(i, 5).Value ' Date range condition
        
        ' Find corresponding AO value from LatAm sheet based on AG match
        foundAO = ""
        For j = 2 To lastRowLatAm
            If wsLatAm.Cells(j, 3).Value = filterValue Then ' Column C (AG) in LatAm
                foundAO = wsLatAm.Cells(j, 2).Value ' Column B (AO) in LatAm
                Exit For
            End If
        Next j
        
        ' If no AO value found, skip row
        If foundAO = "" Then GoTo NextRow
        
        ' Find actual column number in UA69_Updated file
        filterColNum = 0
        On Error Resume Next
        filterColNum = Application.Match(filterCol, wsTarget.Rows(1), 0)
        On Error GoTo 0
        
        ' If filter column not found, skip
        If filterColNum = 0 Then GoTo NextRow
        
        ' Loop through UA69_Updated file and update AG column
        For j = 2 To lastRowTarget
            If wsTarget.Cells(j, filterColNum).Value = foundAO Then
                ' Country filtering logic
                Dim country As String
                country = wsTarget.Cells(j, 4).Value ' Assuming country is in column 4
                
                If InStr(1, countryCondition, "All except", vbTextCompare) > 0 Then
                    ' Exclude listed countries
                    Dim excludedCountries As String
                    excludedCountries = Trim(Replace(countryCondition, "All except", ""))
                    If InStr(1, excludedCountries, country, vbTextCompare) > 0 Then GoTo NextTargetRow
                ElseIf InStr(1, countryCondition, "All", vbTextCompare) > 0 Then
                    ' Include all countries (no filtering needed)
                Else
                    ' Include only specified countries
                    If InStr(1, countryCondition, country, vbTextCompare) = 0 Then GoTo NextTargetRow
                End If
                
                ' Date range filtering
                If Not IsEmpty(dateRange) Then
                    Dim dateValue As Variant, startDate As Date, endDate As Date
                    dateValue = wsTarget.Cells(j, 5).Value ' Assuming date is in column 5
                    
                    If IsDate(dateValue) Then
                        Dim parts() As String
                        If InStr(1, dateRange, "-") > 0 Then
                            parts = Split(dateRange, "-")
                            If UBound(parts) = 1 Then
                                On Error Resume Next
                                startDate = DateValue(Trim(parts(0)))
                                endDate = DateValue(Trim(parts(1)))
                                On Error GoTo 0
                                
                                If IsDate(startDate) And IsDate(endDate) Then
                                    If dateValue < startDate Or dateValue > endDate Then GoTo NextTargetRow
                                End If
                            End If
                        End If
                    End If
                End If
                
                ' Update AG column in UA69_Updated file
                wsTarget.Cells(j, AGColNum).Value = wsSource.Cells(i, wsSource.Cells(i, Columns.Count).End(xlToLeft).Column).Value
            End If
NextTargetRow:
        Next j
NextRow:
    Next i
    
    MsgBox "AG Column updated successfully!", vbInformation
End Sub
