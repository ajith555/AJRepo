Option Explicit

Public Sub UpdateCopySheetAH(ByVal strArgumentAH As String)
    Dim wbMacro As Workbook
    Dim wsRules As Worksheet
    Dim wbCopy As Workbook
    Dim wsCopy As Worksheet
    
    Dim lastRuleRow As Long, lastCopyRow As Long
    Dim i As Long, j As Long
    
    Dim valA As String, valB As String, valC As String, valD As String, valE As String, valF As String
    Dim copyT As String, copyAN As String, copyAM As String, copyAL As String, copyAQ As String
    Dim joinDate As Date, yearsDiff As Long
    Dim matchOk As Boolean
    
    ' Reference to macro workbook (this workbook)
    Set wbMacro = ThisWorkbook
    Set wsRules = wbMacro.Sheets("AH")
    
    ' Open target workbook
    Set wbCopy = Workbooks.Open(strArgumentAH)
    Set wsCopy = wbCopy.Sheets("Copy")
    
    ' Find last rows
    lastRuleRow = wsRules.Cells(wsRules.Rows.Count, "A").End(xlUp).Row
    lastCopyRow = wsCopy.Cells(wsCopy.Rows.Count, "A").End(xlUp).Row
    
    ' Loop through each rule row in Ajith Macro "AH" sheet
    For j = 2 To lastRuleRow
        valA = Trim(CStr(wsRules.Cells(j, "A").Value))
        valB = Trim(CStr(wsRules.Cells(j, "B").Value))
        valC = Trim(CStr(wsRules.Cells(j, "C").Value))
        valD = Trim(CStr(wsRules.Cells(j, "D").Value))
        valE = Trim(CStr(wsRules.Cells(j, "E").Value))
        valF = CStr(wsRules.Cells(j, "F").Value)
        
        ' Loop through each data row in Copy sheet
        For i = 2 To lastCopyRow
            ' Only check if AH column is empty (first match wins)
            If Trim(CStr(wsCopy.Cells(i, "AH").Value)) = "" Then
                copyT = Trim(CStr(wsCopy.Cells(i, "T").Value))
                copyAN = Trim(CStr(wsCopy.Cells(i, "AN").Value))
                copyAM = Trim(CStr(wsCopy.Cells(i, "AM").Value))
                copyAL = Trim(CStr(wsCopy.Cells(i, "AL").Value))
                copyAQ = Trim(CStr(wsCopy.Cells(i, "AQ").Value))
                
                matchOk = True
                
                ' --- Column A check ---
                If UCase(valA) <> "ALL" Then
                    If InStr(1, valA, copyT, vbTextCompare) = 0 Then matchOk = False
                End If
                
                ' --- Column B check ---
                If matchOk Then
                    If UCase(valB) <> "ALL" Then
                        If InStr(1, valB, copyAN, vbTextCompare) = 0 Then matchOk = False
                    End If
                End If
                
                ' --- Column C check ---
                If matchOk Then
                    If UCase(valC) <> "ALL" Then
                        If InStr(1, valC, copyAM, vbTextCompare) = 0 Then matchOk = False
                    End If
                End If
                
                ' --- Column D check (country) ---
                If matchOk Then
                    If UCase(valD) <> "ALL" Then
                        If Left(UCase(valD), 10) = "ALL EXCEPT" Then
                            Dim exclList As Variant, k As Long
                            exclList = Split(Mid(valD, 12), ",")
                            For k = LBound(exclList) To UBound(exclList)
                                If Trim(UCase(copyAL)) = Trim(UCase(exclList(k))) Then
                                    matchOk = False
                                    Exit For
                                End If
                            Next k
                        Else
                            If InStr(1, valD, copyAL, vbTextCompare) = 0 Then matchOk = False
                        End If
                    End If
                End If
                
                ' --- Column E check (years) ---
                If matchOk Then
                    If UCase(valE) <> "ALL" Then
                        If IsDate(copyAQ) Then
                            joinDate = CDate(copyAQ)
                            yearsDiff = Year(Date) - Year(joinDate)
                            
                            If Left(valE, 1) = ">" Then
                                If yearsDiff <= CLng(Replace(Replace(valE, ">", ""), "years", "")) Then matchOk = False
                            ElseIf Left(valE, 1) = "<" Then
                                If yearsDiff >= CLng(Replace(Replace(valE, "<", ""), "years", "")) Then matchOk = False
                            End If
                        Else
                            matchOk = False
                        End If
                    End If
                End If
                
                ' --- If all true, update AH column ---
                If matchOk Then
                    wsCopy.Cells(i, "AH").Value = valF
                End If
            End If
        Next i
    Next j
    
    ' Save & close target workbook
    wbCopy.Close SaveChanges:=True
    
    MsgBox "Update completed successfully!", vbInformation
End Sub
