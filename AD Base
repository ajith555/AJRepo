Sub Update_AG_Column()
    Dim wbSource As Workbook, wbTarget As Workbook
    Dim wsSource As Worksheet, wsTarget As Worksheet
    Dim lastRow As Long, lastRowTarget As Long
    Dim filterValue As String, countryExclusion As String, dateRange As String
    Dim filterColNum As Long, AGColNum As Long
    Dim i As Long, j As Long
    Dim targetRow As Range, filterCol As Range
    
    ' Set workbook references
    Set wbSource = ThisWorkbook  ' Ajith Macro V1.xlsm
    Set wbTarget = Workbooks("UA69_Updated.xlsx")
    
    ' Set worksheet references
    Set wsSource = wbSource.Sheets("Job Code Description")
    Set wsTarget = wbTarget.Sheets("Output")
    
    ' Find last row in source and target
    lastRow = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row
    lastRowTarget = wsTarget.Cells(wsTarget.Rows.Count, 1).End(xlUp).Row
    
    ' Get column numbers for filtering and AG
    filterColNum = 1  ' Assuming filter values are in column A
    AGColNum = Application.Match("AG", wsTarget.Rows(1), 0)
    
    ' If AG column is not found, exit
    If IsError(AGColNum) Then
        MsgBox "AG column not found in UA69_Updated.xlsx", vbExclamation
        Exit Sub
    End If
    
    ' Loop through each row in source sheet
    For i = 2 To lastRow
        filterValue = Trim(wsSource.Cells(i, filterColNum).Value)
        countryExclusion = Trim(wsSource.Cells(i, 4).Value) ' Country exclusion
        dateRange = Trim(wsSource.Cells(i, 5).Value) ' Date range
        
        ' Loop through UA69_Updated file and update AG column
        For j = 2 To lastRowTarget
            If Trim(wsTarget.Cells(j, filterColNum).Value) = filterValue Then
                ' Country exclusion check
                If countryExclusion <> "" And InStr(1, countryExclusion, wsTarget.Cells(j, 4).Value, vbTextCompare) > 0 Then
                    GoTo SkipRow
                End If
                
                ' Date range check
                If dateRange <> "" Then
                    Dim parts() As String
                    Dim startDate As Date, endDate As Date
                    Dim targetDate As Variant
                    
                    parts = Split(dateRange, "-")
                    If UBound(parts) = 1 Then
                        startDate = DateValue(Trim(parts(0)))
                        endDate = DateValue(Trim(parts(1)))
                        targetDate = wsTarget.Cells(j, 5).Value
                        
                        If IsDate(targetDate) Then
                            If targetDate < startDate Or targetDate > endDate Then GoTo SkipRow
                        End If
                    End If
                End If
                
                ' Update AG column
                wsTarget.Cells(j, AGColNum).Value = wsSource.Cells(i, wsSource.UsedRange.Columns.Count).Value
            End If
SkipRow:
        Next j
    Next i
    
    MsgBox "AG Column updated successfully!", vbInformation
End Sub
