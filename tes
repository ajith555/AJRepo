Option Explicit

Sub ExportRepliedSentEmails()
    Dim targetEmail As String
    targetEmail = "abc@ubs.com" ' Replace with the target email address you want to fetch emails from
    Dim numberOfHours As Integer
    numberOfHours = 24 ' Change this number to the desired number of hours (e.g., 24 for 24 hours, 48 for 48 hours)

    ' Create Excel objects
    Dim objExcelApplication As Excel.Application
    Dim objExcelWorkbook As Excel.Workbook
    Dim objExcelWorksheet As Excel.Worksheet

    Set objExcelApplication = New Excel.Application
    objExcelApplication.Visible = True
    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)

    ' Set headers in Excel
    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Sender"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Received Email Time"
        .Cells(1, 3).Font.Bold = True
    End With

    ' Get the Sent Items folder
    Dim objNamespace As Outlook.Namespace
    Set objNamespace = Application.GetNamespace("MAPI")
    Dim objSentItemsFolder As Outlook.Folder
    Set objSentItemsFolder = objNamespace.GetDefaultFolder(olFolderSentMail)

    ' Process the Sent Items folder, including only replied emails within the specified time frame
    ProcessSentItemsFolder objSentItemsFolder, objExcelWorksheet, numberOfHours, targetEmail

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:C").AutoFit
        .Columns("C").ColumnWidth = 20
        .Columns("C").WrapText = False
    End With

    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessSentItemsFolder(ByVal objSentItemsFolder As Outlook.Folder, ByVal objExcelWorksheet As Excel.Worksheet, ByVal numberOfHours As Integer, ByVal targetEmail As String)
    Dim objMail As Outlook.MailItem
    Dim nLastRow As Integer

    On Error Resume Next

    For Each objMail In objSentItemsFolder.Items
        ' Check if the email is within the specified time frame
        If objMail.ReceivedTime >= Now - TimeSerial(numberOfHours, 0, 0) Then
            ' Check if the email has been replied to
            If EmailIsReplied(objMail, targetEmail) Then
                nLastRow = objExcelWorksheet.Cells(objExcelWorksheet.Rows.Count, 1).End(xlUp).Row + 1

                With objExcelWorksheet
                    .Cells(nLastRow, 1) = objMail.Subject
                    .Cells(nLastRow, 2) = objMail.SenderName
                    .Cells(nLastRow, 3) = objMail.ReceivedTime
                End With
            End If
        End If
    Next objMail

    On Error GoTo 0
End Sub

Function EmailIsReplied(ByVal objMail As Outlook.MailItem, ByVal targetEmail As String) As Boolean
    Dim conversation As Outlook.conversation
    Dim table As Outlook.Table
    Dim row As Outlook.Row

    Set conversation = objMail.GetConversation
    Set table = conversation.GetTable

    While Not table.EndOfTable
        Set row = table.GetNextRow
        If row.Item("MessageClass") = "IPM.Note" And row.Item("Subject") = "RE: " & objMail.Subject Then
            ' Check if the sender of the reply is not the target email (i.e., someone else replied)
            If row.Item("SenderEmailAddress") <> targetEmail Then
                EmailIsReplied = True
                Exit Function
            End If
        End If
    Wend

    EmailIsReplied = False
End Function
