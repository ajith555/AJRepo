Option Explicit

Dim objExcelApplication As Object
Dim objExcelWorkbook As Object
Dim objExcelWorksheet As Object
Dim objNamespace As Object
Dim objSentItemsFolder As Object

Sub ExportRepliedEmailsToExcel()
    Dim hoursAgo As Integer
    Dim objItems As Object
    Dim objItem As Object
    Dim rowCount As Integer

    ' Define the number of hours to fetch emails from
    hoursAgo = 24 ' Change this value as needed

    ' Create Excel objects
    Set objExcelApplication = CreateObject("Excel.Application")
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)

    ' Set Excel column headers
    With objExcelWorksheet
        .Cells(1, 1).Value = "Subject"
        .Cells(1, 2).Value = "Received Time"
        .Cells(1, 3).Value = "Sender"
    End With

    rowCount = 2 ' Start from the second row to enter data

    ' Create Outlook application object
    Set objNamespace = CreateObject("Outlook.Application").GetNamespace("MAPI")

    ' Set Sent Items folder
    Set objSentItemsFolder = objNamespace.GetDefaultFolder(5) ' 5 represents the Sent Items folder

    ' Filter emails based on the specified number of hours
    Dim startTime As Date
    startTime = Now - hoursAgo / 24 ' Calculate the start time
    Set objItems = objSentItemsFolder.Items.Restrict("[ReceivedTime] >= '" & Format(startTime, "ddddd h:nn AMPM") & "'")

    ' Loop through the filtered emails and extract data
    For Each objItem In objItems
        If objItem.Class = 43 Then ' 43 represents a MailItem
            ' Check if the email has been replied to
            If objItem.ReplyRecipientNames <> "" Then
                ' Insert email data into Excel
                objExcelWorksheet.Cells(rowCount, 1).Value = objItem.Subject
                objExcelWorksheet.Cells(rowCount, 2).Value = objItem.ReceivedTime
                objExcelWorksheet.Cells(rowCount, 3).Value = objItem.SenderName
                rowCount = rowCount + 1
            End If
        End If
    Next objItem

    ' Format Excel columns and rows
    objExcelWorksheet.Columns.AutoFit

    ' Clean up objects
    Set objExcelWorksheet = Nothing
    Set objExcelWorkbook = Nothing
    Set objSentItemsFolder = Nothing
    Set objNamespace = Nothing
    Set objExcelApplication = Nothing
End Sub
