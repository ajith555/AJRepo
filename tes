Option Explicit

Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet
Dim objinbox As Outlook.Folder

Sub ExportRepliedEmails()
    Dim targetEmail As String
    targetEmail = "your_email@example.com" ' Replace with the target email address you want to fetch emails from

    ' Create Excel objects
    Set objExcelApplication = New Excel.Application
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)

    ' Set fixed row height for all rows in the worksheet
    objExcelWorksheet.Rows.RowHeight = 20

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Recipients"
        .Cells(1, 4).Font.Bold = True
        .Cells(1, 5) = "Excerpts"
        .Cells(1, 5).Font.Bold = True
    End With

    ' Get the specified email account and its Inbox folder
    Dim objNamespace As Outlook.Namespace
    Dim objRootFolder As Outlook.Folder
    Set objNamespace = Outlook.GetNamespace("MAPI")
    Set objRootFolder = objNamespace.Folders(targetEmail)
    Set objinbox = objRootFolder.Folders("Inbox")

    ' Process the folders, including only replied emails
    ProcessFolders objinbox

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:E").AutoFit
        .Columns("E").ColumnWidth = 100
        .Columns("E").WrapText = False
    End With

    RemoveDuplicatesFromWorkbook

    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessFolders(ByVal objCurrentfolder As Outlook.Folder)
    Dim i As Long
    Dim objMail As Outlook.MailItem
    Dim nLastRow As Integer

    On Error Resume Next

    For i = objCurrentfolder.Items.Count To 1 Step -1
        If objCurrentfolder.Items(i).Class = olMail Then
            Set objMail = objCurrentfolder.Items(i)

            ' Check if the email has been replied to
            If objMail.ReplyAllTime <> "1/1/4501 12:00:00 AM" Then
                nLastRow = objExcelWorksheet.Range("A" & objExcelWorksheet.Rows.Count).End(xlUp).Row + 1

                With objExcelWorksheet
                    .Cells(nLastRow, 1) = objMail.Subject
                    .Cells(nLastRow, 2) = objMail.ReceivedTime
                    .Cells(nLastRow, 3) = objMail.SenderName
                End With

                Dim recipients As String
                recipients = ""
                For Each Recipient In objMail.Recipients
                    recipients = recipients & Recipient.Name & "; "
                Next Recipient
                recipients = Left(recipients, Len(recipients) - 2) ' Remove trailing "; "

                With objExcelWorksheet
                    .Cells(nLastRow, 4) = recipients
                    .Cells(nLastRow, 5) = Left(Trim(objMail.Body), 100) & "..."
                End With
            End If
        End If
    Next i

    On Error GoTo 0

    If objCurrentfolder.Folders.Count > 0 Then
        Dim objSubfolder As Outlook.Folder
        For Each objSubfolder In objCurrentfolder.Folders
            ProcessFolders objSubfolder
        Next objSubfolder
    End If
End Sub

Sub RemoveDuplicatesFromWorkbook()
    Dim lastRow As Long
    Dim lastCol As Long
    Dim ws As Worksheet
    Dim rng As Range

    Set ws = objExcelWorkbook.Worksheets(1)
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Set rng = ws.Range(ws.Cells(1, 1), ws.Cells(lastRow, lastCol))
    rng.RemoveDuplicates Columns:=Array(1, 2, 3, 4, 5), Header:=xlYes
End Sub
