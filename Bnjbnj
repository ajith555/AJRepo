Sub MoveDuplicateEmails(ByVal objFolder As Outlook.Folder)
    Dim objDuplicateFolder As Outlook.Folder
    Dim objMail As Outlook.MailItem
    Dim subjectDict As Object ' Dictionary to track duplicate subjects
    Dim i As Long

    ' Check if the "(1) AGED Duplicate" folder exists or create it if it doesn't
    Dim foundDuplicate As Boolean
    foundDuplicate = False
    Dim objSubfolder As Outlook.Folder
    For Each objSubfolder In objinbox.Folders
        If objSubfolder.Name = "(1) AGED Duplicate" Then
            foundDuplicate = True
            Set objDuplicateFolder = objSubfolder
            Exit For
        End If
    Next objSubfolder
    
    If Not foundDuplicate Then
        Set objDuplicateFolder = objinbox.Folders.Add("(1) AGED Duplicate", olFolderInbox)
    End If

    ' Create a Dictionary to track duplicate subjects
    Set subjectDict = CreateObject("Scripting.Dictionary")
    
    For i = objFolder.Items.Count To 1 Step -1
        If objFolder.Items(i).Class = olMail Then
            Set objMail = objFolder.Items(i)
            Dim strReplied As String
            strReplied = objMail.propertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")
            If (strReplied <> "102" And strReplied <> "103") Then ' Only consider unreplied emails
                Dim subject As String
                subject = objMail.Subject
                If Not subjectDict.Exists(subject) Then
                    ' Track the subject and its received time
                    subjectDict.Add subject, objMail.ReceivedTime
                Else
                    ' Compare the current email's received time with the stored received time
                    If objMail.ReceivedTime < subjectDict(subject) Then
                        ' Move the current email to the "(1) AGED Duplicate" folder
                        objMail.Move objDuplicateFolder
                    Else
                        ' Move the stored email to the "(1) AGED Duplicate" folder
                        objFolder.Items.Find("[ReceivedTime]='" & subjectDict(subject) & "'").Move objDuplicateFolder
                        ' Update the stored received time to the current email's received time
                        subjectDict(subject) = objMail.ReceivedTime
                    End If
                End If
            End If
        End If
    Next i
End Sub







Sub MoveDuplicateEmailsInExternalFolder()
    Dim objExternalFolder As Outlook.Folder
    Dim objDuplicateFolder As Outlook.Folder
    Dim objMail As Outlook.MailItem
    Dim subjectDict As Object ' Dictionary to track duplicate subjects
    Dim i As Long

    ' Check if the "(1) AGED External" folder exists or create it if it doesn't
    Dim foundExternal As Boolean
    foundExternal = False
    Dim objFolder As Outlook.Folder
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED External" Then
            foundExternal = True
            Set objExternalFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundExternal Then
        Exit Sub ' Exit if "(1) AGED External" folder doesn't exist
    End If

    ' Check if the "(1) AGED Duplicate" folder exists or create it if it doesn't
    Dim foundDuplicate As Boolean
    foundDuplicate = False
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED Duplicate" Then
            foundDuplicate = True
            Set objDuplicateFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundDuplicate Then
        Set objDuplicateFolder = objinbox.Folders.Add("(1) AGED Duplicate", olFolderInbox)
    End If

    ' Create a Dictionary to track duplicate subjects
    Set subjectDict = CreateObject("Scripting.Dictionary")
    
    ' Loop through items in the external folder and move duplicates
    For i = objExternalFolder.Items.Count To 1 Step -1
        If objExternalFolder.Items(i).Class = olMail Then
            Set objMail = objExternalFolder.Items(i)
            Dim strReplied As String
            strReplied = objMail.propertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")
            If (strReplied <> "102" And strReplied <> "103") Then ' Only consider unreplied emails
                Dim subject As String
                subject = objMail.Subject
                If Not subjectDict.Exists(subject) Then
                    ' Track the subject and its EntryID along with the received time
                    subjectDict.Add subject, Array(objMail.EntryID, objMail.ReceivedTime)
                Else
                    ' Get the stored received time for this subject
                    Dim storedReceivedTime As Date
                    storedReceivedTime = subjectDict(subject)(1)
                    
                    ' Compare the current email's received time with the stored received time
                    If objMail.ReceivedTime < storedReceivedTime Then
                        ' Move the current email to the "(1) AGED Duplicate" folder
                        objMail.Move objDuplicateFolder
                        
                        ' Update the stored received time to the current email's received time
                        subjectDict(subject)(1) = objMail.ReceivedTime
                    Else
                        ' Move the stored email to the "(1) AGED Duplicate" folder
                        objExternalFolder.Items.Find("[EntryID]='" & subjectDict(subject)(0) & "'").Move objDuplicateFolder
                        ' Update the stored received time to the current email's received time
                        subjectDict(subject)(1) = objMail.ReceivedTime
                        ' Update the stored EntryID to the current email's EntryID
                        subjectDict(subject)(0) = objMail.EntryID
                    End If
                End If
            End If
        End If
    Next i
End Sub
