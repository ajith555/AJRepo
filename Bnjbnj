# Path to the CSV file
$csvFilePath = "P:\Invision\URLZIP.csv"

# Import CSV
$urls = Import-Csv -Path $csvFilePath

# Function to check if a file is fully downloaded
function CheckDownloadComplete {
    param ($startTime, $fileName)

    # Check if the file exists and has stopped growing
    $file = Get-Item $fileName
    $fileSizeStart = $file.Length

    Start-Sleep -Seconds 5 # Wait for a moment before checking again

    $fileSizeEnd = $file.Length

    return ($fileSizeStart -eq $fileSizeEnd -and $file.LastWriteTime -gt $startTime)
}

# Loop through each URL
foreach ($url in $urls) {
    # Open URL in Chrome
    Start-Process "chrome.exe" -ArgumentList $url.Url

    # Record the start time
    $startTime = Get-Date

    $fileDownloadStarted = $false

    # Check if a file starts downloading within 30 seconds
    while ((Get-Date) -lt $startTime.AddSeconds(30)) {
        if (Test-Path "$env:USERPROFILE\Downloads\$($url.FileName)") {
            $fileDownloadStarted = $true
            break
        }
        Start-Sleep -Seconds 5
    }

    if (-not $fileDownloadStarted) {
        # No file started to download within 30 seconds, update FileName as "Error"
        $url.FileName = "Error"
    } else {
        # Wait for the download to complete
        while (-not (CheckDownloadComplete -startTime $startTime -fileName "$env:USERPROFILE\Downloads\$($url.FileName)")) {
            Start-Sleep -Seconds 5 # Wait for 5 seconds before checking again
        }
    }

    # Update LastChecked time
    $url.LastChecked = Get-Date

    # Export updated URL list to CSV
    $urls | Export-Csv -Path $csvFilePath -NoTypeInformation

    # Wait for 10 seconds before moving to the next URL
    Start-Sleep -Seconds 10

    # Kill Chrome after processing every 50 URLs
    if (($urls.IndexOf($url) + 1) % 50 -eq 0) {
        # Wait for 5 seconds before killing Chrome
        Start-Sleep -Seconds 5

        # Kill Chrome
        taskkill /IM "chrome.exe" /F /T
    }
}

# Close Chrome after processing all URLs
Start-Sleep -Seconds 5
taskkill /IM "chrome.exe" /F /T
