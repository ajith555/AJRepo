# Path to the Excel file
$excelFilePath = "P:\Invasion\URLPDF.xlsx"

# Load Excel COM objects
$excel = New-Object -ComObject Excel.Application
$workbook = $excel.Workbooks.Open($excelFilePath)
$worksheet = $workbook.Worksheets.Item(1)

# Loop through each URL starting from the second row
for ($i = 2; $i -le $worksheet.UsedRange.Rows.Count; $i++) {
    # Read URL from Excel
    $url = $worksheet.Cells.Item($i, 3).Value2

    # Open URL in Chrome
    Start-Process "chrome.exe" -ArgumentList $url -Wait

    # Wait for the download to complete
    Start-Sleep -Seconds 5  # Adjust this time according to your download speed and file sizes

    # Get the downloaded file name
    $downloadedFile = Get-ChildItem -Path $env:USERPROFILE\Downloads | Sort-Object -Property LastWriteTime -Descending | Select-Object -First 1

    # Debug output to check downloaded file name
    Write-Host "Downloaded File Name: $($downloadedFile.Name)"

    # Update the Excel with the downloaded file name
    $worksheet.Cells.Item($i, 4).Value2 = $downloadedFile.Name
    $workbook.Save()

    # Debug output to check if Excel cell is updated
    Write-Host "Excel Cell Updated with File Name: $($worksheet.Cells.Item($i, 4).Value2)"

    # Wait for 10 seconds before moving to the next URL
    Start-Sleep -Seconds 5

    # Kill Chrome after processing every 50 URLs
    if (($i % 3) -eq 0) {
        # Wait for 5 seconds before killing Chrome
        Start-Sleep -Seconds 5

        # Kill Chrome
        Stop-Process -Name "chrome" -Force
    }
}

# Close Excel
$workbook.Close($false) # Don't save changes since we already saved them
$excel.Quit()
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($worksheet) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null
[System.GC]::Collect()
[System.GC]::WaitForPendingFinalizers()
