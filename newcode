Option Explicit

Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet

Sub ExportRepliedSentEmails()
    Dim targetEmail As String
    targetEmail = "abc@ubs.com" ' Replace with the target email address you want to fetch emails from
    Dim numberOfDays As Integer
    numberOfDays = 7 ' Change this number to the desired number of days

    ' Create Excel objects
    Set objExcelApplication = New Excel.Application
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)

    ' Set fixed row height for all rows in the worksheet
    objExcelWorksheet.Rows.RowHeight = 20

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Sender"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Recipient"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Received Email Time"
        .Cells(1, 4).Font.Bold = True
        .Cells(1, 5) = "Replied Email Time"
        .Cells(1, 5).Font.Bold = True
    End With

    ' Get the specified email account and its Sent Items folder
    Dim objNamespace As Outlook.Namespace
    Dim objRootFolder As Outlook.Folder
    Set objNamespace = Outlook.GetNamespace("MAPI")
    Set objRootFolder = objNamespace.Folders(targetEmail)
    Dim objSentItemsFolder As Outlook.Folder
    Set objSentItemsFolder = objRootFolder.Folders("Sent Items")

    ' Process the Sent Items folder, including only replied emails within the specified number of days
    ProcessSentItemsFolder objSentItemsFolder, numberOfDays

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:E").AutoFit
        .Columns("E").ColumnWidth = 20
        .Columns("E").WrapText = False
    End With

    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessSentItemsFolder(ByVal objSentItemsFolder As Outlook.Folder, ByVal numberOfDays As Integer)
    Dim objMail As Outlook.MailItem
    Dim nLastRow As Integer

    On Error Resume Next

    For Each objMail In objSentItemsFolder.Items
        ' Check if the email is within the specified number of days
        Dim nDateDiff As Integer
        nDateDiff = DateDiff("d", objMail.ReceivedTime, Now)

        ' Check if the email is not from the target email address and is within the specified number of days
        If nDateDiff <= numberOfDays And objMail.SenderEmailAddress <> "abc@ubs.com" Then
            ' Check if the email has been replied to
            If objMail.ReceivedByName <> objMail.SentOnBehalfOfName Then
                nLastRow = objExcelWorksheet.Range("A" & objExcelWorksheet.Rows.Count).End(xlUp).Row + 1

                With objExcelWorksheet
                    .Cells(nLastRow, 1) = objMail.Subject
                    .Cells(nLastRow, 2) = objMail.SenderName
                    .Cells(nLastRow, 3) = objMail.To
                    .Cells(nLastRow, 4) = objMail.ReceivedTime
                    .Cells(nLastRow, 5) = objMail.RepliedTime
                End With
            End If
        End If
    Next objMail

    On Error GoTo 0
End Sub
