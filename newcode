Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet
Dim objInbox As Outlook.Folder
Dim objProcessedEmails As Object ' Dictionary to store processed email EntryIDs

Sub ExportEmailsNotReplied()
    Dim targetEmail As String
    targetEmail = "your_email@example.com" ' Replace this with the desired email address

    Dim objNamespace As Outlook.Namespace
    Dim objRootFolder As Outlook.Folder

    ' Create and initialize the Excel application and worksheet
    Set objExcelApplication = CreateObject("Excel.Application")
    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Excerpts"
        .Cells(1, 4).Font.Bold = True
    End With

    objExcelApplication.Visible = True
    objExcelWorkbook.Activate

    ' Initialize the dictionary to store processed emails
    Set objProcessedEmails = CreateObject("Scripting.Dictionary")

    ' Get the specified email account and its Inbox folder
    Set objNamespace = Outlook.GetNamespace("MAPI")
    Set objRootFolder = objNamespace.Folders(targetEmail)

    ' Check and process the folders
    Call ProcessFolders(objRootFolder)

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:C").AutoFit
        .Columns("D").ColumnWidth = 100
        .Columns("D").WrapText = False
    End With

    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessFolders(ByVal objCurrentFolder As Outlook.Folder)
    Dim objMail As Outlook.MailItem
    Dim i As Long

    For i = objCurrentFolder.Items.Count To 1 Step -1
        If objCurrentFolder.Items(i).Class = olMail Then
            Set objMail = objCurrentFolder.Items(i)
            Call ProcessEmail(objMail)
        End If
    Next

    ' Recursively process subfolders
    If objCurrentFolder.Folders.Count > 0 Then
        For Each objSubfolder In objCurrentFolder.Folders
            Call ProcessFolders(objSubfolder)
        Next
    End If
End Sub

Sub ProcessEmail(ByVal objMail As Outlook.MailItem)
    Dim strReplied As String
    Dim nDateDiff As Integer
    Dim nLastRow As Integer

    strReplied = objMail.PropertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")

    ' Check if the email has not been processed already
    If Not EmailProcessed(objMail.EntryID) Then
        If (Not (strReplied = 102)) And (Not (strReplied = 103)) Then
            nDateDiff = DateDiff("d", objMail.SentOn, Now)
            If nDateDiff < 7 Then
                nLastRow = objExcelWorksheet.Range("A" & objExcelWorksheet.Rows.Count).End(xlUp).Row + 1
                With objExcelWorksheet
                    .Cells(nLastRow, 1) = objMail.Subject
                    .Cells(nLastRow, 2) = objMail.ReceivedTime
                    .Cells(nLastRow, 3) = objMail.SenderName
                    .Cells(nLastRow, 4) = Left(Trim(objMail.Body), 100) & "..."
                End With

                ' Add the processed email to the dictionary
                objProcessedEmails(objMail.EntryID) = True
            End If
        End If
    End If
End Sub

Function EmailProcessed(ByVal entryID As String) As Boolean
    EmailProcessed = objProcessedEmails.Exists(entryID)
End Function
