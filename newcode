# Set the path to your CSV file
$csvPath = "C:\path\to\your\file.csv"

# Read the CSV file
$urls = Import-Csv -Path $csvPath

# Define the Chrome executable path
$chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"

# Define the download directory
$downloadDirectory = "C:\Users\shettyka\Downloads"  # Adjust as per your system

# Open Chrome with the first URL
Start-Process -FilePath $chromePath -ArgumentList $urls[0].url

# Loop through each URL in the CSV, starting from the second one
foreach ($url in $urls[1..$urls.Count]) {
    # Wait for 10 seconds
    Start-Sleep -Seconds 10

    # Check if a file has been downloaded
    $downloadedFiles = Get-ChildItem -Path $downloadDirectory
    $fileDownloaded = $false
    $downloadedFileName = $null
    foreach ($file in $downloadedFiles) {
        if ($file.Extension -eq ".crdownload" -or $file.Extension -eq ".tmp") {
            # Skip files being currently downloaded
            continue
        }
        elseif ($file.LastWriteTime -ge (Get-Date).AddSeconds(-10)) {
            # File has been downloaded within the last 10 seconds
            $fileDownloaded = $true
            $downloadedFileName = $file.Name
            break
        }
    }

    # If file downloaded, update Excel with the downloaded file name
    if ($fileDownloaded) {
        $url | Add-Member -MemberType NoteProperty -Name "DownloadedFile" -Value $downloadedFileName
        $url | Export-Csv -Path $csvPath -NoTypeInformation -Append
    }

    # Navigate to the next URL in the same Chrome tab
    $chromeProcess = Get-Process -Name "chrome" | Select-Object -First 1
    $windowHandle = $chromeProcess.MainWindowHandle
    $chromeWindow = [System.Diagnostics.Process]::GetProcesses() | Where-Object { $_.MainWindowHandle -eq $windowHandle }
    $chromeProcessId = $chromeWindow.Id
    $scriptBlock = {
        param($chromeProcessId, $url)
        $chrome = [System.Diagnostics.Process]::GetProcessById($chromeProcessId)
        $webBrowser = $chrome.MainWindowHandle
        $navigateScript = @"
            var chromeTab = window.open("$url", "_self");
            chromeTab.location.reload();
"@
        Add-Type -AssemblyName System.Windows.Forms
        $webBrowser.GetType().InvokeMember("ExecWB", [System.Reflection.BindingFlags]::InvokeMethod, $null, $webBrowser, 270, $null, $null, $null) | Out-Null
        Start-Sleep -Milliseconds 500
        $webBrowser.Document.parentWindow.execScript($navigateScript, "javascript")
    }
    Start-Sleep -Milliseconds 1000
    Invoke-Command -ScriptBlock $scriptBlock -ArgumentList $chromeProcessId, $url.url
}
