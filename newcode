Option Explicit

Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet

Sub ExportEmailsNotReplied()
    Dim objInbox As Outlook.Folder
    Dim sharedMailboxEmail As String
    sharedMailboxEmail = "sh-operations@ubb.com" ' Replace this with the shared mailbox email address
    
    On Error Resume Next
    Set objExcelApplication = GetObject(, "Excel.Application")
    If objExcelApplication Is Nothing Then
        Set objExcelApplication = CreateObject("Excel.Application")
    End If
    On Error GoTo 0
    
    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)
    
    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Excerpts"
        .Cells(1, 4).Font.Bold = True
    End With
    
    objExcelApplication.Visible = True
    objExcelWorkbook.Activate
    
    Set objInbox = GetSharedMailboxInbox(sharedMailboxEmail)
    If objInbox Is Nothing Then
        MsgBox "Failed to access the shared mailbox. Make sure you have the necessary permissions and the mailbox is added to your Outlook as a new account.", vbExclamation
        Exit Sub
    End If
    
    Call ProcessFolders(objInbox)
    
    With objExcelWorksheet
        .Columns("A:C").AutoFit
        .Rows.RowHeight = 15
        .Columns("D").ColumnWidth = 100
        .Columns("D").WrapText = False
    End With
    
    MsgBox "Complete!", vbExclamation
End Sub

Function GetSharedMailboxInbox(ByVal sharedMailboxEmail As String) As Outlook.Folder
    Dim objNamespace As Outlook.Namespace
    Dim objRecipient As Outlook.Recipient
    
    On Error Resume Next
    Set objNamespace = Application.GetNamespace("MAPI")
    Set objRecipient = objNamespace.CreateRecipient(sharedMailboxEmail)
    
    If objRecipient.Resolve Then
        Set GetSharedMailboxInbox = objNamespace.GetSharedDefaultFolder(objRecipient, olFolderInbox)
    End If
    
    On Error GoTo 0
End Function

Sub ProcessFolders(ByVal objRootFolder As Outlook.Folder)
    Dim objFolderStack As New Collection
    Dim objSubfolder As Outlook.Folder
    Dim objMail As Outlook.MailItem
    Dim nDateDiff As Integer
    Dim nLastRow As Integer
    Dim objMailFolder As Outlook.Folder ' Add this explicit declaration

    objFolderStack.Add objRootFolder ' Add the root folder to the stack
    
    Do While objFolderStack.Count > 0
        Set objSubfolder = objFolderStack(1) ' Get the first folder from the stack
        objFolderStack.Remove 1 ' Remove the first folder from the stack
        
        ' Process the items in the current folder
        For Each objMail In objSubfolder.Items
            If objMail.Class = olMail Then
                ' Check if the email has been replied to
                If objMail.PropertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003") Is Nothing Then
                    ' Email has not been replied to
                    nDateDiff = DateDiff("d", objMail.ReceivedTime, Now)
                    If nDateDiff < 7 Then
                        nLastRow = objExcelWorksheet.Range("A" & objExcelWorksheet.Rows.Count).End(xlUp).Row + 1
                        With objExcelWorksheet
                            .Cells(nLastRow, 1) = objMail.Subject
                            .Cells(nLastRow, 2) = objMail.ReceivedTime
                            .Cells(nLastRow, 3) = objMail.SenderName
                            .Cells(nLastRow, 4) = Left(Trim(objMail.Body), 100)
                        End With
                    End If
                End If
            End If
        Next

        ' Add subfolders to the stack for further processing
        If objSubfolder.Folders.Count > 0 Then
            For Each objMailFolder In objSubfolder.Folders
                objFolderStack.Add objMailFolder
            Next
        End If
    Loop
End Sub
