Option Explicit

Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet
Dim objinbox As Outlook.Folder

Sub ExportEmailsNotReplied()
    Dim targetEmail As String
    targetEmail = "kushal-ajith.shetty@ubs.com"
    Dim objNamespace As Outlook.Namespace
    Dim objRootFolder As Outlook.Folder
    Dim objABCFolder As Outlook.Folder
    Dim objABCDuplicatesFolder As Outlook.Folder
    Dim objABCRepliedFolder As Outlook.Folder
    
    ' Create Excel objects
    Set objExcelApplication = New Excel.Application
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)
    
    ' Set fixed row height for all rows in the worksheet
    objExcelWorksheet.Rows.RowHeight = 22

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Recipients"
        .Cells(1, 4).Font.Bold = True
        .Cells(1, 5) = "Excerpts"
        .Cells(1, 5).Font.Bold = True
    End With
    
    ' Get the specified email account and its Inbox folder
    Set objNamespace = Outlook.GetNamespace("MAPI")
    Set objRootFolder = objNamespace.Folders(targetEmail)
    Set objinbox = objRootFolder.Folders("Inbox")
    
    ' Check if the "(1) AGED" folder exists or create it if it doesn't
    Dim foundABCFolder As Boolean
    foundABCFolder = False
    Dim objFolder As Outlook.Folder
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED" Then
            foundABCFolder = True
            Set objABCFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundABCFolder Then
        Set objABCFolder = objinbox.Folders.Add("(1) AGED", olFolderInbox)
    End If
    
    ' Check if the "(1) AGED Duplicates" folder exists or create it if it doesn't
    Dim foundABCDuplicatesFolder As Boolean
    foundABCDuplicatesFolder = False
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED Duplicates" Then
            foundABCDuplicatesFolder = True
            Set objABCDuplicatesFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundABCDuplicatesFolder Then
        Set objABCDuplicatesFolder = objinbox.Folders.Add("(1) AGED Duplicates", olFolderInbox)
    End If
    
    ' Check if the "(1) AGED Replied" folder exists or create it if it doesn't
    Dim foundABCRepliedFolder As Boolean
    foundABCRepliedFolder = False
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED Replied" Then
            foundABCRepliedFolder = True
            Set objABCRepliedFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundABCRepliedFolder Then
        Set objABCRepliedFolder = objinbox.Folders.Add("(1) AGED Replied", olFolderInbox)
    End If
    
    ' Check and process the folders (including exclusion, replied emails, and duplicate handling)
    ProcessFolders objinbox, objABCFolder, objABCDuplicatesFolder, objABCRepliedFolder, objNamespace

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:D").AutoFit
        .Columns("E").ColumnWidth = 100
        .Columns("E").WrapText = False
    End With

    RemoveDuplicatesFromWorkbook

    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessFolders(ByVal objCurrentfolder As Outlook.Folder, ByVal objDestinationFolder As Outlook.Folder, ByVal objDuplicatesFolder As Outlook.Folder, ByVal objRepliedFolder As Outlook.Folder, ByVal objNamespace As Outlook.Namespace)
    Dim i As Long
    Dim objMail As Outlook.MailItem
    Dim strReplied As String
    Dim nDateDiff As Integer
    Dim nReplyDateDiff As Integer
    Dim nLastRow As Integer
    Dim Recipient As Outlook.Recipient
    
    On Error Resume Next
    
    ' Create dictionaries to store subject and email items
    Dim dictSubject As Object
    Set dictSubject = CreateObject("Scripting.Dictionary")

    ' Loop through emails and process them
    For i = objCurrentfolder.Items.Count To 1 Step -1
        If objCurrentfolder.Items(i).Class = olMail Then
            Set objMail = objCurrentfolder.Items(i)
            strReplied = objMail.propertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")

            ' Add the condition to check if the sender name is to be excluded
            Dim excludedSenders As String
            excludedSenders = "Shetty, Kushal-Ajith; Sakaria, Pramod" ' Add other sender names as needed
            If InStr(1, excludedSenders, objMail.SenderName, vbTextCompare) = 0 Then
                nDateDiff = DateDiff("d", objMail.SentOn, Now)
                nReplyDateDiff = DateDiff("d", objMail.ReceivedTime, Now)

                ' Check if email is from the last 7 days and not replied for more than 2 days
                If nDateDiff <= 7 And nReplyDateDiff > 2 Then
                    ' Move replied emails to "(1) AGED Replied" folder
                    If (strReplied = "102") Or (strReplied = "103") Then
                        objMail.Move objRepliedFolder
                    Else
                        ' Check if the subject already exists in the dictionary
                        If dictSubject.Exists(objMail.Subject) Then
                            ' Check the received time of the existing email
                            Dim existingItem As Outlook.MailItem
                            Set existingItem = dictSubject(objMail.Subject)
                            If existingItem.ReceivedTime < objMail.ReceivedTime Then
                                ' Move the existing email to "(1) AGED Duplicates" folder
                                objMail.Move objDuplicatesFolder
                                ' Update the dictionary with the latest email item
                                Set dictSubject(objMail.Subject) = objMail
                            Else
                                ' Move the current email to "(1) AGED Duplicates" folder
                                objMail.Move objDuplicatesFolder
                            End If
                        Else
                            ' Add the email item to the dictionary
                            dictSubject.Add objMail.Subject, objMail
                            ' Move the email to "(1) AGED" folder
                            objMail.Move objDestinationFolder
                        End If
                    End If
                End If
            End If
        End If
    Next i

    On Error GoTo 0
    
    If objCurrentfolder.Folders.Count > 0 Then
        Dim objSubfolder As Outlook.Folder
        For Each objSubfolder In objCurrentfolder.Folders
            ProcessFolders objSubfolder, objDestinationFolder, objDuplicatesFolder, objRepliedFolder, objNamespace
        Next objSubfolder
    End If
End Sub

Sub RemoveDuplicatesFromWorkbook()
    Dim lastRow As Long
    Dim lastCol As Long
    Dim ws As Worksheet
    Dim rng As Range
    
    Set ws = objExcelWorkbook.Worksheets(1)
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Set rng = ws.Range(ws.Cells(1, 1), ws.Cells(lastRow, lastCol))
    rng.RemoveDuplicates Columns:=Array(1, 2, 3, 4, 5), Header:=xlYes
End Sub
