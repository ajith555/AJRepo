Dim objexcelApplication As Excel.Application
Dim objexcelworkbook As Excel.Workbook
Dim objexcelworksheet As Excel.Worksheet

Const MY_CUSTOM_PROPERTY_URL As String = "http://schemas.mycompany.com/mapi/proptag/MyCustomProperty"

Sub ExportEmailsNotReplied()
    Dim objinbox As Outlook.Folder
    Set objexcelApplication = CreateObject("Excel.Application")
    Set objexcelworkbook = objexcelApplication.Workbooks.Add
    Set objexcelworksheet = objexcelworkbook.Worksheets(1)
    
    With objexcelworksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Excerpts"
        .Cells(1, 4).Font.Bold = True
    End With
    
    objexcelApplication.Visible = True
    objexcelworkbook.Activate
    
    Set objinbox = Application.Session.GetDefaultFolder(olFolderInbox)
    Call ProcessFolders(objinbox)
    
    With objexcelworksheet
        Columns("A:C").AutoFit
        Rows.RowHeight = 15
        .Columns("D").ColumnWidth = 100
        .Columns("D").WrapText = False
    End With
    
    MsgBox "Complete!", vbExclamation
End Sub

Sub ProcessFolders(ByVal objcurrentFolder As Outlook.Folder)
    Dim objMail As Outlook.MailItem
    Dim nDateDiff As Integer
    Dim nLastrow As Integer
    Dim i As Long ' Declare the variable "i" here
    
    For i = objcurrentFolder.Items.Count To 1 Step -1
        If objcurrentFolder.Items(i).Class = olMail Then
            Set objMail = objcurrentFolder.Items(i)
            ' Set the custom property "MyCustomProperty" to "True" when the email is replied to.
            If objMail.ResponseState = olReplied Then
                objMail.PropertyAccessor.SetProperty MY_CUSTOM_PROPERTY_URL, True
                objMail.Save ' Save the changes to the custom property
            End If
        End If
    Next

    If objcurrentFolder.Folders.Count > 0 Then
        Dim objsubfolder As Outlook.Folder ' Declare the variable "objsubfolder" here
        For Each objsubfolder In objcurrentFolder.Folders
            Call ProcessFolders(objsubfolder)
        Next
    End If
End Sub

Sub ExportEmailsNotReplied()
    '... (existing code)

    Set objinbox = Application.Session.GetDefaultFolder(olFolderInbox)
    Call ProcessFolders(objinbox)

    ' Retrieve emails that do not have the "MyCustomProperty" custom property or have the value "False".
    For Each objMail In objinbox.Items
        If objMail.Class = olMail Then
            ' Check if the "MyCustomProperty" custom property exists and its value is "False" (not replied).
            Dim repliedStatus As Boolean
            repliedStatus = objMail.PropertyAccessor.GetProperty(MY_CUSTOM_PROPERTY_URL)
            If Not repliedStatus Then
                nDateDiff = DateDiff("d", objMail.ReceivedTime, Now)
                If nDateDiff < 7 Then
                    nLastrow = objexcelworksheet.Range("A" & objexcelworksheet.Rows.Count).End(xlUp).Row + 1
                    With objexcelworksheet
                        .Cells(nLastrow, 1) = objMail.Subject
                        .Cells(nLastrow, 2) = objMail.ReceivedTime
                        .Cells(nLastrow, 3) = objMail.SenderName
                        .Cells(nLastrow, 4) = Left(Trim(objMail.Body), 100)
                    End With
                End If
            End If
        End If
    Next objMail

    '... (existing code)
End Sub
