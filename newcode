Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet
Dim objInbox As Outlook.Folder
Dim objABCFolder As Outlook.Folder

Sub ExportEmailsNotReplied()
    Dim objNamespace As Outlook.Namespace
    Dim objAccounts As Outlook.Accounts
    Dim objAccount As Outlook.Account
    
    Dim strEmailAccount As String
    strEmailAccount = InputBox("Enter the email account to check (e.g., john.doe@example.com):")
    
    On Error Resume Next
    Set objNamespace = Application.GetNamespace("MAPI")
    Set objAccounts = objNamespace.Accounts
    
    For Each objAccount In objAccounts
        If objAccount.SmtpAddress = strEmailAccount Then
            On Error GoTo 0
            Exit For
        End If
    Next objAccount
    
    If objAccount Is Nothing Then
        MsgBox "Email account not found. Please enter a valid email account.", vbExclamation
        Exit Sub
    End If
    
    On Error GoTo ErrorHandler ' Add error handling for potential issues
    
    Set objExcelApplication = CreateObject("Excel.Application")
    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)
    
    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Excerpts"
        .Cells(1, 4).Font.Bold = True
    End With
    
    objExcelApplication.Visible = True
    objExcelWorkbook.Activate
    
    Set objInbox = objNamespace.GetSharedDefaultFolder(objAccount, olFolderInbox)
    Set objABCFolder = objInbox.Folders("ABC") ' Assumes there's a folder named "ABC" under Inbox, change this if needed
    
    Call ProcessFolders(objInbox)
    
    With objExcelWorksheet
        .Columns("A:C").AutoFit
        .Columns("D").ColumnWidth = 100
        .Columns("D").WrapText = False
    End With
    
    MsgBox "Complete!", vbExclamation
    Exit Sub ' Exit the subroutine if everything ran successfully
    
ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbExclamation
    On Error Resume Next
    objExcelWorkbook.Close SaveChanges:=False
    objExcelApplication.Quit
    Set objExcelWorksheet = Nothing
    Set objExcelWorkbook = Nothing
    Set objExcelApplication = Nothing
    Exit Sub
End Sub

Sub ProcessFolders(ByVal objCurrentFolder As Outlook.Folder)
    Dim i As Long
    Dim objMail As Outlook.MailItem
    Dim strReplied As String
    Dim nDateDiff As Integer
    Dim nLastRow As Integer
    
    On Error Resume Next ' Add error handling for potential issues in loop
    
    For i = objCurrentFolder.Items.Count To 1 Step -1
        If objCurrentFolder.Items(i).Class = olMail Then
            Set objMail = objCurrentFolder.Items(i)
            strReplied = objMail.PropertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")
            
            If (Not (strReplied = "102")) And (Not (strReplied = "103")) Then
                nDateDiff = DateDiff("d", objMail.SentOn, Now)
                If nDateDiff < 7 Then
                    nLastRow = objExcelWorksheet.Range("A" & objExcelWorksheet.Rows.Count).End(xlUp).Row + 1
                    With objExcelWorksheet
                        .Cells(nLastRow, 1) = objMail.Subject
                        .Cells(nLastRow, 2) = objMail.ReceivedTime
                        .Cells(nLastRow, 3) = objMail.SenderName
                        .Cells(nLastRow, 4) = Left(Trim(objMail.Body), 100) & "..."
                    End With
                    objMail.Move objABCFolder ' Move the email to the "ABC" folder
                End If
            End If
        End If
    Next
    
    On Error GoTo 0 ' Reset error handling
    
    If objCurrentFolder.Folders.Count > 0 Then
        Dim objSubfolder As Outlook.Folder
        For Each objSubfolder In objCurrentFolder.Folders
            Call ProcessFolders(objSubfolder)
        Next objSubfolder
    End If
End Sub
