Option Explicit

Dim objExcelApplication As Excel.Application
Dim objExcelWorkbook As Excel.Workbook
Dim objExcelWorksheet As Excel.Worksheet
Dim objinbox As Outlook.Folder

Sub ExportEmailsNotReplied()
    On Error Resume Next ' Enable error handling
    
    Dim targetEmail As String
    targetEmail = "kushal-ajith.shetty@ubs.com"
    
    Dim objNamespace As Outlook.Namespace
    Dim objRootFolder As Outlook.Folder
    Dim objABCFolder As Outlook.Folder
    
    ' Create Excel objects
    Set objExcelApplication = New Excel.Application
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)
    
    ' Set fixed row height for all rows in the worksheet
    objExcelWorksheet.Rows.RowHeight = 22

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Sender"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Recipients"
        .Cells(1, 4).Font.Bold = True
        .Cells(1, 5) = "Excerpts"
        .Cells(1, 5).Font.Bold = True
    End With
    
    ' Get the specified email account and its Inbox folder
    Set objNamespace = Outlook.GetNamespace("MAPI")
    Set objRootFolder = objNamespace.Folders(targetEmail)
    Set objinbox = objRootFolder.Folders("Inbox")
    
    ' Check if the "ABC" folder exists or create it if it doesn't
    Dim foundABC As Boolean
    foundABC = False
    Dim objFolder As Outlook.Folder
    For Each objFolder In objinbox.Folders
        If objFolder.Name = "(1) AGED" Then
            foundABC = True
            Set objABCFolder = objFolder
            Exit For
        End If
    Next objFolder
    
    If Not foundABC Then
        Set objABCFolder = objinbox.Folders.Add("(1) AGED", olFolderInbox)
    End If
    
    ' Check and process the folders
    ProcessFolders objinbox, objABCFolder

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:D").AutoFit
        .Columns("E").ColumnWidth = 100
        .Columns("E").WrapText = False
    End With

    ' Remove duplicates based on "Subject" column and remove entire rows
    RemoveDuplicatesFromSubjectColumn

    ' Release objects to free resources
    Set objABCFolder = Nothing
    Set objinbox = Nothing
    Set objRootFolder = Nothing
    Set objNamespace = Nothing

    ' Release Excel objects
    objExcelWorkbook.Close SaveChanges:=True
    objExcelApplication.Quit
    Set objExcelWorksheet = Nothing
    Set objExcelWorkbook = Nothing
    Set objExcelApplication = Nothing

    MsgBox "Complete!", vbExclamation
    
    On Error GoTo 0 ' Disable error handling
End Sub

Sub ProcessFolders(ByVal objCurrentfolder As Outlook.Folder, ByVal objDestinationFolder As Outlook.Folder)
    ' Rest of the code remains the same...
End Sub

Sub RemoveDuplicatesFromSubjectColumn()
    Dim lastRow As Long
    Dim ws As Worksheet
    Dim rng As Range
    
    Set ws = objExcelWorkbook.Worksheets(1)
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    Set rng = ws.Range(ws.Cells(1, 1), ws.Cells(lastRow, 1)) ' Range based on "Subject" column
    rng.RemoveDuplicates Columns:=Array(1), Header:=xlYes
End Sub
