Option Explicit

Dim objExcelApplication As Object
Dim objExcelWorkbook As Object
Dim objExcelWorksheet As Object
Dim objNamespace As Object
Dim objSentItemsFolder As Object
Dim HoursToFetch As Integer ' Number of hours to fetch emails

Sub FetchEmailsFromSentItems()
    ' Set the number of hours to fetch emails
    HoursToFetch = 24 ' Change this value to the desired number of hours
    
    ' Create Excel objects
    Set objExcelApplication = CreateObject("Excel.Application")
    objExcelApplication.Visible = True ' Set Excel application visible before working with columns

    Set objExcelWorkbook = objExcelApplication.Workbooks.Add
    Set objExcelWorksheet = objExcelWorkbook.Worksheets(1)
    
    ' Set fixed row height for all rows in the worksheet
    objExcelWorksheet.Rows.RowHeight = 20

    With objExcelWorksheet
        .Cells(1, 1) = "Subject"
        .Cells(1, 1).Font.Bold = True
        .Cells(1, 2) = "Received Time"
        .Cells(1, 2).Font.Bold = True
        .Cells(1, 3) = "Replied Time"
        .Cells(1, 3).Font.Bold = True
        .Cells(1, 4) = "Sender"
        .Cells(1, 4).Font.Bold = True
    End With
    
    ' Get the Outlook Namespace and "Sent Items" folder
    Set objNamespace = GetObject("", "Outlook.Application").GetNamespace("MAPI")
    Set objSentItemsFolder = objNamespace.GetDefaultFolder(5) ' olFolderSentMail

    ' Fetch and display emails from "Sent Items" folder
    FetchAndDisplayEmails objSentItemsFolder

    ' Format the Excel columns and rows
    With objExcelWorksheet
        .Columns("A:D").AutoFit
    End With

    ' Clean up
    Set objExcelWorksheet = Nothing
    Set objExcelWorkbook = Nothing
End Sub

Sub FetchAndDisplayEmails(ByVal objFolder As Object)
    Dim objItem As Object
    Dim rowIndex As Integer
    
    rowIndex = 2 ' Start from the second row (first row is for headers)
    
    For Each objItem In objFolder.Items
        If TypeOf objItem Is Object Then ' Check if the item is an object
            Dim objMail As Object
            Set objMail = objItem ' Cast the item to an object
            ' Calculate the time difference in hours
            Dim timeDiff As Double
            timeDiff = DateDiff("h", objMail.ReceivedTime, Now)
            
            ' Check if the email is within the specified number of hours
            If timeDiff <= HoursToFetch Then
                With objExcelWorksheet
                    .Cells(rowIndex, 1) = objMail.Subject
                    .Cells(rowIndex, 2) = objMail.ReceivedTime
                    .Cells(rowIndex, 3) = GetRepliedTime(objMail) ' Display Replied Time
                    .Cells(rowIndex, 4) = objMail.SenderName
                End With
                rowIndex = rowIndex + 1
            End If
        End If
    Next objItem
End Sub

Function GetRepliedTime(ByVal objMail As Object) As Variant
    ' Function to retrieve the time when a reply was sent for the given email
    Dim objNamespace As Object
    Dim objReply As Object
    
    Set objNamespace = GetObject("", "Outlook.Application").GetNamespace("MAPI")
    
    ' Find the corresponding reply in the "Sent Items" folder
    For Each objReply In objNamespace.GetDefaultFolder(5).Items ' olFolderSentMail
        If objReply.Subject = "RE: " & objMail.Subject And objReply.ReceivedByName = objMail.SenderName Then
            GetRepliedTime = objReply.SentOn
            Exit Function
        End If
    Next objReply
    
    ' If no corresponding reply found, return a blank value
    GetRepliedTime = ""
End Function
