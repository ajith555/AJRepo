Sub MoveDuplicateEmails(ByVal objFolder As Outlook.Folder)
    Dim objDuplicateFolderInternal As Outlook.Folder
    Dim objDuplicateFolderExternal As Outlook.Folder
    Dim objMail As Outlook.MailItem
    Dim subjectDictInternal As Object ' Dictionary to track duplicate subjects for Internal folder
    Dim subjectDictExternal As Object ' Dictionary to track duplicate subjects for External folder
    Dim latestEmailsInternal As Object ' Dictionary to track the latest emails by subject for Internal folder
    Dim latestEmailsExternal As Object ' Dictionary to track the latest emails by subject for External folder
    Dim i As Long

    ' Check if the "(1) AGED Internal" folder exists or create it if it doesn't
    Dim foundDuplicateInternal As Boolean
    foundDuplicateInternal = False
    Dim objSubfolderInternal As Outlook.Folder
    For Each objSubfolderInternal In objFolder.Folders
        If objSubfolderInternal.Name = "(1) AGED Internal" Then
            foundDuplicateInternal = True
            Set objDuplicateFolderInternal = objSubfolderInternal
            Exit For
        End If
    Next objSubfolderInternal
    
    If Not foundDuplicateInternal Then
        Set objDuplicateFolderInternal = objFolder.Folders.Add("(1) AGED Internal", olFolderInbox)
    End If

    ' Check if the "(1) AGED External" folder exists or create it if it doesn't
    Dim foundDuplicateExternal As Boolean
    foundDuplicateExternal = False
    Dim objSubfolderExternal As Outlook.Folder
    For Each objSubfolderExternal In objFolder.Folders
        If objSubfolderExternal.Name = "(1) AGED External" Then
            foundDuplicateExternal = True
            Set objDuplicateFolderExternal = objSubfolderExternal
            Exit For
        End If
    Next objSubfolderExternal
    
    If Not foundDuplicateExternal Then
        Set objDuplicateFolderExternal = objFolder.Folders.Add("(1) AGED External", olFolderInbox)
    End If

    ' Create Dictionaries to track duplicate subjects and latest emails for both Internal and External folders
    Set subjectDictInternal = CreateObject("Scripting.Dictionary")
    Set latestEmailsInternal = CreateObject("Scripting.Dictionary")
    
    Set subjectDictExternal = CreateObject("Scripting.Dictionary")
    Set latestEmailsExternal = CreateObject("Scripting.Dictionary")
    
    For i = objFolder.Items.Count To 1 Step -1
        If objFolder.Items(i).Class = olMail Then
            Set objMail = objFolder.Items(i)
            Dim strReplied As String
            strReplied = objMail.propertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x10810003")
            If (strReplied <> "102" And strReplied <> "103") Then ' Only consider unreplied emails
                Dim subject As String
                subject = objMail.Subject
                Dim receivedDate As Date
                receivedDate = objMail.ReceivedTime
                
                Dim objDuplicateFolder As Outlook.Folder
                If InStr(subject, "Internal") > 0 Then
                    Set objDuplicateFolder = objDuplicateFolderInternal
                    If Not subjectDictInternal.Exists(subject) Then
                        subjectDictInternal.Add subject, objMail.EntryID ' Track the subject and its EntryID
                        latestEmailsInternal.Add subject, receivedDate ' Track the latest email's received date
                    Else
                        Dim latestEmailEntryIDInternal As String
                        latestEmailEntryIDInternal = subjectDictInternal(subject)
                        Dim latestEmailInternal As Outlook.MailItem
                        Set latestEmailInternal = objFolder.Items.Find("[EntryID]='" & latestEmailEntryIDInternal & "'")
                        If Not latestEmailInternal Is Nothing Then
                            latestEmailInternal.Move objDuplicateFolder
                        End If
                        
                        ' Update the latest email's received date and EntryID in the dictionaries
                        latestEmailsInternal(subject) = receivedDate
                        subjectDictInternal(subject) = objMail.EntryID
                    End If
                ElseIf InStr(subject, "External") > 0 Then
                    Set objDuplicateFolder = objDuplicateFolderExternal
                    If Not subjectDictExternal.Exists(subject) Then
                        subjectDictExternal.Add subject, objMail.EntryID ' Track the subject and its EntryID
                        latestEmailsExternal.Add subject, receivedDate ' Track the latest email's received date
                    Else
                        Dim latestEmailEntryIDExternal As String
                        latestEmailEntryIDExternal = subjectDictExternal(subject)
                        Dim latestEmailExternal As Outlook.MailItem
                        Set latestEmailExternal = objFolder.Items.Find("[EntryID]='" & latestEmailEntryIDExternal & "'")
                        If Not latestEmailExternal Is Nothing Then
                            latestEmailExternal.Move objDuplicateFolder
                        End If
                        
                        ' Update the latest email's received date and EntryID in the dictionaries
                        latestEmailsExternal(subject) = receivedDate
                        subjectDictExternal(subject) = objMail.EntryID
                    End If
                End If
            End If
        End If
    Next i
End Sub
